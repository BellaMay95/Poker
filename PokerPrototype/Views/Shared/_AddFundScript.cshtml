<script>
    $("#profile-dropdown").click(function () {
        showProfileModal("");
    });

    function showProfileModal(username) {
        //alert("called showProfileModal with " + username);
        $("#profile-avatar").empty().append($("<span class='spinner'></span>"));
        $.post("/ajax/viewProfile", {
            username: username
        },
        profileHandler);
    }
    function profileHandler(response) {
        //alert(JSON.stringify(response));
        $(".spinner").remove();
        $("#profile-avatar").empty().append("<img src='" + response.avatar + "'>");
        $("#profile-username").empty().append(response.username);
        $("#profile-currency").empty().append("Currency: " + response.currency);
        var $friendBody = $("#friendBody").empty();
        //alert(response.friendUser.size);
        
        for (var i = 0; i < response.friendUser.length; i++) {
            var friend = response.friendUser[i];
            var avatar = response.friendAvatar[i];
            //var $line = $("");
            $div = $("<div class='col=sm-6'></div>");
            $div.append("<img style='width: 64px; height: 64px;' src='" + avatar + "'>");
            $div.append($("<span></span>").text(" " + friend));
            $friendBody.append($div);
        }
        if (response.canEdit) {
            $("#profile-top-right").empty().append("<a href='/editprofile'><button>Edit Profile</button></a>");
        }
       //alert(response.username);
        else {
            if (response.isFriend) {
                $("#profile-top-right").empty().append("<button id='remove'>Remove Friend</button>");
                $("#profile-top-right").append("<button id='message'>Send Message</button>");

                $("#remove").click(function () {
                    removeFriend(response.username);
                })
                $("#message").click(function () {
                    message(response.username);
                })
            }
            else {
                $("#profile-top-right").empty().append("<button id='add'>Add Friend</button>");
                if (response.isAdmin) {
                    $("#profile-top-right").append("<button id='message'>Send Message</button>");
                }
                //alert(response.username);
                $("#add").click(function () {
                    addFriend(response.username);
                })
                $("#message").click(function () {
                    message(response.username);
                })
            }
        }
    }

    function addFriend(newuser)
    {
        $(".modal-footer").append("<div class='spinner' style='float:left'</div>")
        $.post("/ajax/addfriend", {
            newuser
            }, addFriendHandler);
    }

    function addFriendHandler(response) {
        //alert(JSON.stringify(response.connectError));
        $(".spinner").remove();
        var success = true;
        $("#profile-top-right").empty().append("<button>Remove Friend</button>");
    }

    function removeFriend(newuser) {
        $(".modal-footer").append("<div class='spinner' style='float:left'</div>")
        $.post("/ajax/removefriend", {
            newuser
        }, removeFriendHandler);
    }

    function removeFriendHandler(response) {
        //alert(JSON.stringify(response.connectError));
        $(".spinner").remove();
        var success = true;
        $("#profile-top-right").empty().append("<button>Add Friend</button>");
    }

    var messageList = [];
    $("#messages-dropdown").click(function () {
        showMessageModal($(".active").first().text());
    })
    $("#message-menu").on('click', 'li', function () {
        $(".active").removeClass("active");
        $(this).addClass("active");
        showMessageModal($(this).first().text());
    })
    function showMessageModal(str) {
        $("#message-content").empty().append("<span class='spinner'></span>");
        if (str == "inbox") {
            $("#message-content").removeClass("well");
            $.post("/ajax/inbox", inboxHandler);
        }
        else if (str == "compose") {
            $("#message-content").addClass("well");
            composeHandler();
        }
        else{
            $("#message-content").removeClass("well");
            $.post("/ajax/sentmessages", sentHandler);
        }
    }
    function printMessageList(heading) {
        if (messageList.length == 0) {
            $("#message-content").empty().append("<h2>empty</h2>");
            return;
        }
        var $thead = $("<thead><tr><th>" + heading + "</th><th>Date</th></tr></thead>")
        var $tbody = $("<tbody id='message-tbody'></tbody>")
        for (var i = 0; i < messageList.length; i++) {
            var $row = $("<tr data-ind='" + i + "'></tr>");
            $row.append("<td>" + messageList[i].username + "</td>");
            $row.append("<td>" + messageList[i].date + "</td>");
            $tbody.append($row);
        }

        $table = $("<table class='table table-hover'></table>").append($thead).append($tbody);
        $("#message-content").empty().append($table);
        $("tbody").on("click", "tr", function () {
            var i = $(this).data('ind');
            alert(messageList[i].message);
        });
    }
    function inboxHandler(response) {
        messageList = response;
        printMessageList("sender");
    }
    function sentHandler(response) {
        messageList = response;
        printMessageList("Sent to");
    }
    function composeHandler() {
        var $row = $("<div class='form-group row' id='to-group'></div>");
        var $col3 = $('<div class="col-sm-3"></div>');
        $col3.append('<label class="control-label" for="to-input">recipient</label>');
        var $col9 = $('<div class="col-sm-9">');
        $col9.append('<input type="text" class="form-control" id="to-input" />');
        var msg = ('<div class="col-sm-3"></div>' + '<div class="col-sm-9"><span id="to-msg" class="help-block"></span></div>');
        $row.append($col3).append($col9).append(msg);

        var $row2 = $("<div class='form-group row' id='send-group'></div>");
        var $col12 = $('<div class="col-sm-12"></div>');
        $col12.append('<label class="control-label" for="send-input">message</label>');
        $col12.append('<textarea class="form-control" rows="5" id="send-input"></textarea>');
        msg = ('<div class="col-sm-12"><span id="send-msg" class="help-block"></span></div>');
        $row2.append($col12).append(msg);

        var button = "<button id='send-btn' class='btn btn-primary' style='float: right;'>Send Message</button>";
        $("#message-content").empty().append($row).append($row2).append(button);
        $('#send-btn').click(function(){
            $.post("/ajax/sendmessage", {
                to: $("#to-input").val(),
                message: $("#send-input").val()
            },
            sendMessageHandler);
        });
    }
    function sendMessageHandler(response) {
        var success = true;
        if (response.toError.length > 0) {
            success = false;
            $("#to-group").addClass("has-error");
            $("#to-msg").text(response.toError);
        } else {
            $("#to-group").removeClass("has-error");
            $("#to-msg").text("");
        }
        if (response.messageError.length > 0) {
            success = false;
            $("#send-group").addClass("has-error");
            $("#send-msg").text(response.messageError);
        } else {
            $("#send-group").removeClass("has-error");
            $("#send-msg").text("");
        }
        if (success) {
            sentHandler();
        }
    }





    $("#fund-btn").click(submitPayment);
    function submitPayment() {
        $(".modal-footer").append("<div class='spinner' style='float:left'></div>")
        $.post("/ajax/payment", {
            amount: $('#amount-input').val(),
            name: $('#name-input').val(),
            cardNumber: $('#card-number-input').val(),
            cvc: $('#cvc-input').val(),
            expires: $('#expires-input').val(),
            password: $('#password-input').val()
        },
        paymentHandler);
    }

    function paymentHandler(response) {
        $(".spinner").remove();
        var success = true;
        if (response.amountError.length > 0) {
            success = false;
            $("#amount-group").addClass("has-error");
            $("#amount-msg").text(response.amountError);
        } else {
            $("#amount-group").removeClass("has-error");
            $("#amount-msg").text("");
        }
        if (response.nameError.length > 0) {
            success = false;
            $("#name-group").addClass("has-error");
            $("#name-msg").text(response.nameError);
        } else {
            $("#name-group").removeClass("has-error");
            $("#name-msg").text("");
        }
        if (response.cardNumberError.length > 0) {
            success = false;
            $("#card-number-group").addClass("has-error");
            $("#card-number-msg").text(response.cardNumberError);
        } else {
            $("#card-number-group").removeClass("has-error");
            $("#card-number-msg").text("");
        }
        if (response.cvcError.length > 0) {
            success = false;
            $("#cvc-group").addClass("has-error");
            $("#cvc-msg").text(response.cvcError);
        } else {
            $("#cvc-group").removeClass("has-error");
            $("#cvc-msg").text("");
        }
        if (response.expiresError.length > 0) {
            success = false;
            $("#expires-group").addClass("has-error");
            $("#expires-msg").text(response.expiresError);
        } else {
            $("#expires-group").removeClass("has-error");
            $("#expires-msg").text("");
        }
        if (response.passwordError.length > 0) {
            success = false;
            $("#password-group").addClass("has-error");
            $("#password-msg").text(response.passwordError);
        } else {
            $("#password-group").removeClass("has-error");
            $("#password-msg").text("");
        }
        if (success) {
            alert("funds successfully added!");
            $('#fund-modal').modal('toggle');
            //refresh the page to update value?
        }
    }
</script>
